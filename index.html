<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONLINE MAFIA</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}

body{
    font-family:'Inter',sans-serif;
    background:linear-gradient(135deg,#0f0f0f,#1a1a2e,#16213e);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    color:white;
}

.card{
    width:95%;
    max-width:500px;
    padding:25px;
    border-radius:20px;
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(15px);
    border:1px solid rgba(255,255,255,0.1);
}

h1{margin-bottom:20px;}

input{
    width:100%;
    padding:12px;
    margin:8px 0;
    border-radius:10px;
    border:none;
    background:rgba(255,255,255,0.1);
    color:white;
}

button{
    width:100%;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
    border:none;
    font-weight:600;
    background:linear-gradient(90deg,#00c853,#64dd17);
    color:white;
    cursor:pointer;
}

.hidden{display:none;}

.player{
    padding:8px;
    margin:6px 0;
    border-radius:8px;
    background:rgba(255,255,255,0.08);
}

.hostTag{
    color:yellow;
    font-weight:800;
    margin-left:6px;
}

.dead{
    background:rgba(255,0,0,0.4);
    text-decoration:line-through;
}

.phase{
    text-align:center;
    font-size:18px;
    margin-bottom:10px;
}
</style>
</head>

<body>

<div class="card" id="menu">
<h1>ONLINE MAFIA</h1>

<input id="nickname" placeholder="Your Name">
<input id="players" type="number" min="4" max="20" placeholder="Players (4-20)">
<input id="mafia" type="number" placeholder="Mafia Count">

<button onclick="createRoom()">CREATE ROOM</button>

<hr style="margin:15px 0;opacity:0.3">

<input id="joinCode" placeholder="Room Code">
<button onclick="joinRoom()">JOIN ROOM</button>

<div id="roomInfo"></div>
</div>

<div class="card hidden" id="game">
<div class="phase" id="phase">Lobby</div>
<div id="playersList"></div>

<div id="voteArea" class="hidden">
<select id="voteSelect"></select>
<button onclick="vote()">Vote</button>
</div>

<button id="startBtn" class="hidden" onclick="startGame()">Start Game</button>
<button id="nextBtn" class="hidden" onclick="togglePhase()">Next Phase</button>
</div>

<script>
let peer;
let connections = {};
let isHost = false;
let myId = null;
let myName = "";
let players = {};
let votes = {};
let phase = "lobby";

function generateCode(){
    return Math.random().toString(36).substring(2,7).toUpperCase();
}

function createRoom(){
    isHost = true;
    myName = document.getElementById("nickname").value || "Host";
    const code = generateCode();

    peer = new Peer(code,{
        secure:true,
        host:'0.peerjs.com',
        port:443,
        path:'/'
    });

    peer.on("open", id=>{
        myId = id;

        // AUTO JOIN HOST
        players[id] = {name: myName, alive:true, host:true};

        document.getElementById("menu").classList.add("hidden");
        document.getElementById("game").classList.remove("hidden");

        document.getElementById("roomInfo").innerHTML = "Room Code: <b>"+id+"</b>";
        document.getElementById("startBtn").classList.remove("hidden");

        updatePlayers();
    });

    peer.on("connection", conn=>{
        connections[conn.peer] = conn;

        conn.on("data", data=>{
            if(data.type === "join"){
                players[data.id] = {name:data.name, alive:true, host:false};
                updatePlayers();
            }
            if(data.type === "vote"){
                votes[data.id] = data.target;
                checkVotes();
            }
        });

        // Send full player list to new player
        conn.on("open", ()=>{
            conn.send({type:"players", players});
        });
    });
}

function joinRoom(){
    myName = document.getElementById("nickname").value || "Player";
    const code = document.getElementById("joinCode").value;

    peer = new Peer({
        secure:true,
        host:'0.peerjs.com',
        port:443,
        path:'/'
    });

    peer.on("open", id=>{
        myId = id;
        const conn = peer.connect(code);

        conn.on("open", ()=>{
            conn.send({type:"join", id:myId, name:myName});
        });

        conn.on("data", data=>{
            if(data.type === "players"){
                players = data.players;
                document.getElementById("menu").classList.add("hidden");
                document.getElementById("game").classList.remove("hidden");
                updatePlayers();
            }
            if(data.type === "vote"){
                votes[data.id] = data.target;
                updatePlayers();
            }
            if(data.type === "phase"){
                phase = data.phase;
                updatePhase();
            }
        });
    });
}

function updatePlayers(){
    let html="";
    for(let id in players){
        let p = players[id];
        html += `<div class="player ${p.alive?'':'dead'}">
            ${p.name}
            ${p.host?'<span class="hostTag">[HOST]</span>':''}
        </div>`;
    }
    document.getElementById("playersList").innerHTML = html;

    if(isHost) broadcast({type:"players", players});
    updateVoteOptions();
}

function updateVoteOptions(){
    let select = document.getElementById("voteSelect");
    select.innerHTML = "";
    for(let id in players){
        if(players[id].alive && id !== myId){
            select.innerHTML += `<option value="${id}">${players[id].name}</option>`;
        }
    }
}

function vote(){
    const target = document.getElementById("voteSelect").value;

    if(isHost){
        votes[myId] = target;
        checkVotes();
    } else {
        peer.connections[Object.keys(peer.connections)[0]][0]
            .send({type:"vote", id:myId, target});
    }
}

function checkVotes(){
    const aliveCount = Object.values(players).filter(p=>p.alive).length;

    if(Object.keys(votes).length === aliveCount){
        let count = {};
        for(let v in votes){
            count[votes[v]] = (count[votes[v]]||0)+1;
        }
        let max = Object.keys(count).reduce((a,b)=>count[a]>count[b]?a:b);
        players[max].alive = false;
        votes = {};
        updatePlayers();
    }
}

function togglePhase(){
    phase = phase === "night" ? "day" : "night";
    updatePhase();
    broadcast({type:"phase", phase});
}

function updatePhase(){
    document.getElementById("phase").innerText = phase.toUpperCase();
    if(phase==="day") document.getElementById("voteArea").classList.remove("hidden");
    else document.getElementById("voteArea").classList.add("hidden");
}

function startGame(){
    alert("Game start logic can be expanded here");
}

function broadcast(obj){
    for(let id in connections){
        connections[id].send(obj);
    }
}
</script>

</body>
</html>
