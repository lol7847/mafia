<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONLINE MAFIA</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}

body{
    font-family:'Inter',sans-serif;
    background:linear-gradient(135deg,#0f0f0f,#1a1a2e,#16213e);
    background-size:200% 200%;
    animation:bgMove 12s ease infinite;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    color:white;
}

@keyframes bgMove{
    0%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
    100%{background-position:0% 50%;}
}

.card{
    width:95%;
    max-width:430px;
    padding:30px;
    border-radius:20px;
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(20px);
    border:1px solid rgba(255,255,255,0.1);
    box-shadow:0 20px 50px rgba(0,0,0,0.7);
}

h1{font-weight:800;margin-bottom:20px;}

input{
    width:100%;
    padding:14px;
    margin:10px 0;
    border-radius:12px;
    border:none;
    background:rgba(255,255,255,0.1);
    color:white;
}

button{
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:none;
    font-weight:600;
    background:linear-gradient(90deg,#00c853,#64dd17);
    color:white;
    cursor:pointer;
}

.hidden{display:none;}

.player{
    padding:10px;
    border-radius:10px;
    background:rgba(255,255,255,0.08);
    margin:6px 0;
}

.dead{
    background:rgba(255,0,0,0.4);
    text-decoration:line-through;
}

.phase{
    font-size:20px;
    margin-bottom:10px;
    text-align:center;
}
</style>
</head>

<body>

<div class="card" id="menu">
<h1>ONLINE MAFIA</h1>

<input id="nickname" placeholder="Your Name">
<input id="players" type="number" min="4" max="20" placeholder="Players (4-20)">
<input id="mafia" type="number" placeholder="Mafia Count">

<button onclick="createRoom()">CREATE ROOM</button>

<hr style="margin:15px 0;opacity:0.3">

<input id="joinCode" placeholder="Room Code">
<button onclick="joinRoom()">JOIN ROOM</button>

<div id="roomInfo"></div>
</div>

<div class="card hidden" id="roleScreen">
<h2>Your Role</h2>
<h1 id="roleText"></h1>
<button onclick="enterGame()">Continue</button>
</div>

<div class="card hidden" id="game">
<div class="phase" id="phase">Lobby</div>
<div id="playersList"></div>

<div id="voteArea" class="hidden">
<select id="voteSelect"></select>
<button onclick="vote()">Vote</button>
</div>

<button id="startBtn" class="hidden" onclick="startGame()">Start Game</button>
<button id="nextBtn" class="hidden" onclick="togglePhase()">Next Phase</button>
</div>

<script>
let peer;
let connections = {};
let isHost = false;
let myId = null;
let myName = "";
let myRole = "";
let players = {};
let votes = {};
let phase = "lobby";

function generateCode(){
    return Math.random().toString(36).substring(2,7).toUpperCase();
}

function createRoom(){
    isHost = true;
    myName = document.getElementById("nickname").value || "Host";
    const code = generateCode();

    peer = new Peer(code,{
        secure:true,
        host:'0.peerjs.com',
        port:443,
        path:'/'
    });

    peer.on("open", id=>{
        myId = id;
        players[id] = {name: myName, alive:true};
        document.getElementById("roomInfo").innerHTML = "Room Code: <b>"+id+"</b>";
        document.getElementById("startBtn").classList.remove("hidden");
    });

    peer.on("connection", conn=>{
        connections[conn.peer] = conn;

        conn.on("data", data=>{
            if(data.type === "join"){
                players[data.id] = {name:data.name, alive:true};
                updatePlayers();
            }
            if(data.type === "vote"){
                votes[data.id] = data.target;
                checkVotes();
            }
        });
    });
}

function joinRoom(){
    myName = document.getElementById("nickname").value || "Player";
    const code = document.getElementById("joinCode").value;

    peer = new Peer({
        secure:true,
        host:'0.peerjs.com',
        port:443,
        path:'/'
    });

    peer.on("open", id=>{
        myId = id;
        const conn = peer.connect(code);

        conn.on("open", ()=>{
            conn.send({type:"join", id:myId, name:myName});
        });

        conn.on("data", data=>{
            if(data.type === "role"){
                myRole = data.role;
                showRole();
            }
            if(data.type === "players"){
                players = data.players;
                updatePlayers();
            }
            if(data.type === "phase"){
                phase = data.phase;
                updatePhase();
            }
            if(data.type === "kill"){
                players[data.id].alive = false;
                updatePlayers();
            }
        });
    });
}

function startGame(){
    const mafiaCount = parseInt(document.getElementById("mafia").value);
    const ids = Object.keys(players);

    let roles = [];
    for(let i=0;i<mafiaCount;i++) roles.push("MAFIA");
    for(let i=0;i<ids.length-mafiaCount;i++) roles.push("CITIZEN");

    roles.sort(()=>Math.random()-0.5);

    ids.forEach((id,index)=>{
        players[id].role = roles[index];

        if(id === myId){
            myRole = roles[index];
            showRole();
        } else {
            connections[id].send({type:"role", role:roles[index]});
        }
    });

    broadcast({type:"players", players});
}

function showRole(){
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("roleScreen").classList.remove("hidden");
    document.getElementById("roleText").innerText = myRole;
}

function enterGame(){
    document.getElementById("roleScreen").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");

    if(isHost){
        document.getElementById("nextBtn").classList.remove("hidden");
    }

    updatePlayers();
}

function updatePlayers(){
    let html="";
    for(let id in players){
        html += `<div class="player ${players[id].alive?'':'dead'}">${players[id].name}</div>`;
    }
    document.getElementById("playersList").innerHTML = html;

    if(isHost) broadcast({type:"players", players});
    updateVoteOptions();
}

function updateVoteOptions(){
    let select = document.getElementById("voteSelect");
    select.innerHTML = "";
    for(let id in players){
        if(players[id].alive && id !== myId){
            select.innerHTML += `<option value="${id}">${players[id].name}</option>`;
        }
    }
}

function vote(){
    const target = document.getElementById("voteSelect").value;

    if(isHost){
        votes[myId] = target;
        checkVotes();
    } else {
        peer.connections[Object.keys(peer.connections)[0]][0]
            .send({type:"vote", id:myId, target});
    }
}

function checkVotes(){
    const aliveCount = Object.values(players).filter(p=>p.alive).length;

    if(Object.keys(votes).length === aliveCount){
        let count = {};
        for(let v in votes){
            count[votes[v]] = (count[votes[v]]||0)+1;
        }
        let max = Object.keys(count).reduce((a,b)=>count[a]>count[b]?a:b);
        players[max].alive = false;
        broadcast({type:"kill", id:max});
        votes = {};
        updatePlayers();
        checkWin();
    }
}

function checkWin(){
    let mafia=0, citizens=0;
    for(let id in players){
        if(players[id].alive){
            if(players[id].role==="MAFIA") mafia++;
            else citizens++;
        }
    }

    if(mafia===0) alert("CITIZENS WIN!");
    if(mafia>=citizens) alert("MAFIA WIN!");
}

function togglePhase(){
    phase = phase === "night" ? "day" : "night";
    broadcast({type:"phase", phase});
    updatePhase();
}

function updatePhase(){
    document.getElementById("phase").innerText = phase.toUpperCase();
    if(phase==="day") document.getElementById("voteArea").classList.remove("hidden");
    else document.getElementById("voteArea").classList.add("hidden");
}

function broadcast(obj){
    for(let id in connections){
        connections[id].send(obj);
    }
}
</script>

</body>
</html>
