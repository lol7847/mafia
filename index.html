<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONLINE MAFIA</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}

body{
    font-family:'Inter',sans-serif;
    background:linear-gradient(135deg,#0f0f0f,#1a1a2e,#16213e);
    background-size:200% 200%;
    animation:bgMove 12s ease infinite;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    color:white;
}

@keyframes bgMove{
    0%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
    100%{background-position:0% 50%;}
}

.card{
    width:95%;
    max-width:430px;
    padding:30px;
    border-radius:20px;
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(20px);
    border:1px solid rgba(255,255,255,0.1);
    box-shadow:0 20px 50px rgba(0,0,0,0.7);
    transition:0.3s ease;
}

h1{
    font-weight:800;
    margin-bottom:20px;
}

input,select{
    width:100%;
    padding:14px;
    margin:10px 0;
    border-radius:12px;
    border:none;
    background:rgba(255,255,255,0.1);
    color:white;
    outline:none;
}

input:focus,select:focus{
    background:rgba(255,255,255,0.15);
}

button{
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:none;
    font-weight:600;
    font-size:15px;
    cursor:pointer;
    background:linear-gradient(90deg,#00c853,#64dd17);
    color:white;
    transition:0.2s;
}

button:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 20px rgba(0,200,83,0.3);
}

.hidden{display:none;}

.player{
    padding:10px;
    border-radius:10px;
    background:rgba(255,255,255,0.08);
    margin:6px 0;
}

.player.dead{
    background:rgba(255,0,0,0.3);
    text-decoration:line-through;
}

.phase{
    font-size:22px;
    font-weight:600;
    text-align:center;
    margin-bottom:15px;
}

.roleReveal{
    font-size:30px;
    text-align:center;
    margin:20px 0;
    font-weight:800;
}

.fade{
    animation:fadeIn 0.4s ease;
}

@keyframes fadeIn{
    from{opacity:0;transform:translateY(10px);}
    to{opacity:1;transform:translateY(0);}
}
</style>
</head>

<body>

<div class="card fade" id="menu">
<h1>ONLINE MAFIA</h1>

<input id="roomName" placeholder="Room Name">
<input id="nickname" placeholder="Your Name">
<input type="number" id="players" placeholder="Players (4-20)" min="4" max="20">
<input type="number" id="mafia" placeholder="Mafia Count">

<button onclick="createRoom()">CREATE ROOM</button>

<hr style="margin:15px 0;opacity:0.3">

<input id="joinCode" placeholder="Room Code">
<button onclick="joinRoom()">JOIN ROOM</button>

<div id="roomInfo" style="margin-top:10px;"></div>
</div>


<div class="card hidden fade" id="roleScreen">
<h2>Your Role</h2>
<div class="roleReveal" id="role"></div>
<button onclick="enterGame()">Continue</button>
</div>


<div class="card hidden fade" id="game">
<div class="phase" id="phase">Lobby</div>
<div id="playersList"></div>

<div id="voteSection" class="hidden">
<select id="voteSelect"></select>
<button onclick="sendVote()">Vote</button>
</div>

<button id="startBtn" class="hidden" onclick="startGame()">Start Game</button>
<button id="nextBtn" class="hidden" onclick="nextPhase()">Next Phase</button>
<button id="restartBtn" class="hidden" onclick="restartGame()">Restart</button>
</div>


<script>
let peer, conn;
let clients=[];
let isHost=false;
let myRole=null;
let myName="";
let playersData={};
let votes={};
let phase="lobby";

function generateCode(){
    return Math.random().toString(36).substring(2,7).toUpperCase();
}

function createRoom(){
    isHost=true;
    myName=document.getElementById("nickname").value||"Host";
    const code=generateCode();
    peer=new Peer(code);

    peer.on("open",id=>{
        document.getElementById("roomInfo").innerHTML="Room Code: <b>"+id+"</b>";
        playersData[id]={name:myName,alive:true};
    });

    peer.on("connection",c=>{
        clients.push(c);
        c.on("data",handleHostData);
    });
}

function joinRoom(){
    myName=document.getElementById("nickname").value||"Player";
    const code=document.getElementById("joinCode").value;
    peer=new Peer();

    peer.on("open",id=>{
        conn=peer.connect(code);
        conn.on("open",()=>{
            conn.send({type:"join",id:id,name:myName});
        });
        conn.on("data",handleClientData);
    });
}

function handleHostData(data){
    if(data.type==="join"){
        playersData[data.id]={name:data.name,alive:true};
        updatePlayers();
    }
    if(data.type==="vote"){
        votes[data.id]=data.target;
        checkVotes();
    }
}

function handleClientData(data){
    if(data.type==="role"){myRole=data.role;showRole();}
    if(data.type==="players"){playersData=data.players;updatePlayers();}
    if(data.type==="phase"){phase=data.phase;updatePhase();}
    if(data.type==="kill"){playersData[data.id].alive=false;updatePlayers();}
    if(data.type==="restart"){location.reload();}
}

function broadcast(obj){
    clients.forEach(c=>c.send(obj));
}

function startGame(){
    let ids=Object.keys(playersData);
    let mafiaCount=parseInt(document.getElementById("mafia").value);
    let roles=[];

    for(let i=0;i<mafiaCount;i++) roles.push("MAFIA");
    for(let i=0;i<ids.length-mafiaCount;i++) roles.push("CITIZEN");

    roles.sort(()=>Math.random()-0.5);

    ids.forEach((id,i)=>{
        playersData[id].role=roles[i];
        if(id===peer.id){
            myRole=roles[i];
            showRole();
        }else{
            clients[i-1].send({type:"role",role:roles[i]});
        }
    });

    phase="night";
    broadcast({type:"phase",phase:"night"});
}

function showRole(){
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("roleScreen").classList.remove("hidden");
    document.getElementById("role").innerText=myRole;
}

function enterGame(){
    document.getElementById("roleScreen").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    if(isHost){
        document.getElementById("nextBtn").classList.remove("hidden");
    }
    updatePlayers();
}

function updatePlayers(){
    let html="";
    for(let id in playersData){
        let p=playersData[id];
        html+=`<div class="player ${p.alive?'':'dead'}">${p.name}</div>`;
    }
    document.getElementById("playersList").innerHTML=html;
    if(isHost) broadcast({type:"players",players:playersData});
    updateVoteOptions();
}

function updateVoteOptions(){
    let select=document.getElementById("voteSelect");
    select.innerHTML="";
    for(let id in playersData){
        if(playersData[id].alive && playersData[id].name!==myName){
            select.innerHTML+=`<option value="${id}">${playersData[id].name}</option>`;
        }
    }
}

function sendVote(){
    let target=document.getElementById("voteSelect").value;
    if(isHost){
        votes[peer.id]=target;
        checkVotes();
    }else{
        conn.send({type:"vote",id:peer.id,target:target});
    }
}

function checkVotes(){
    if(Object.keys(votes).length===Object.keys(playersData).filter(id=>playersData[id].alive).length){
        let count={};
        for(let v in votes){
            count[votes[v]]=(count[votes[v]]||0)+1;
        }
        let max=Object.keys(count).reduce((a,b)=>count[a]>count[b]?a:b);
        playersData[max].alive=false;
        broadcast({type:"kill",id:max});
        votes={};
        updatePlayers();
        checkWin();
    }
}

function checkWin(){
    let mafia=0,citizens=0;
    for(let id in playersData){
        if(playersData[id].alive){
            if(playersData[id].role==="MAFIA") mafia++;
            else citizens++;
        }
    }
    if(mafia===0) alert("CITIZENS WIN!");
    if(mafia>=citizens) alert("MAFIA WIN!");
}

function nextPhase(){
    phase=phase==="night"?"day":"night";
    broadcast({type:"phase",phase:phase});
    updatePhase();
}

function updatePhase(){
    document.getElementById("phase").innerText=phase.toUpperCase();
    if(phase==="day") document.getElementById("voteSection").classList.remove("hidden");
    else document.getElementById("voteSection").classList.add("hidden");
}

function restartGame(){
    broadcast({type:"restart"});
    location.reload();
}
</script>

</body>
</html>
